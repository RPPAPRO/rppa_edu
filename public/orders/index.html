<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>edu_rppa ¬∑ Orders</title>
    <link rel="stylesheet" href="/assets/app.css"/>
    <style>
        /* –ü–ª–æ—Å–∫–∏–µ —Å—Ç—Ä–æ–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ */
        .rows{display:grid;grid-template-columns:1fr;gap:8px}
        .row-item{
          display:grid;
          grid-template-columns: 36px 1.2fr 2fr 0.7fr auto;
          gap:10px; align-items:center;
          padding:10px 12px; border:1px solid rgba(255,255,255,.08); border-radius:10px;
          background:#0e1420; /* –ø–ª–æ—Å–∫–æ, –±–µ–∑ —Ç–µ–Ω–∏ */
        }
        .row-item img{width:32px;height:32px;object-fit:cover;border-radius:6px;border:1px solid rgba(255,255,255,.08)}
        .row-item .name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .row-item .desc{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .qty{display:flex;align-items:center;gap:6px;justify-self:end}
        .qty input{width:70px;text-align:center}
        .totals{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
        @media(max-width:900px){
          .row-item{grid-template-columns:32px 1fr;grid-auto-rows:auto}
          .row-item .name{grid-column:2}
          .row-item .desc{grid-column:2}
          .row-item .price{grid-column:2}
          .row-item .qty{grid-column:2;justify-self:start}
        }
    </style>
</head>
<body>
<header class="topbar">
    <div class="logo">edu_rppa</div>
    <div class="subtitle">Orders</div>
    <nav class="links">
        <a href="/">Home</a>
        <a href="/users/">Users</a>
        <a href="/products/">Products</a>
        <a class="active" href="/orders/">Orders</a>
    </nav>
    <div class="spacer"></div>
    <button class="btn secondary" id="btn-logout">Logout</button>
</header>

<main class="content">
    <section class="card">
        <h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
        <div class="desc">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ; –Ω–∏–∂–µ ‚Äî JSON –∫–æ—Ä–∑–∏–Ω—ã –∏ cookies.</div>

        <div class="actions">
            <button class="btn" id="btn-load">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</button>
            <input id="p-filter" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ name/description‚Ä¶"/>
            <div class="spacer"></div>
            <div class="totals">
                <span class="badge" id="badge-count">items: 0</span>
                <span class="badge" id="badge-sum">total: 0.00</span>
                <button class="btn secondary" id="btn-clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </div>

        <div class="rows mt12" id="rows"></div>

        <div class="mt12" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
                <h3 style="margin:6px 0">Cart JSON</h3>
                <pre id="cart-json">‚Äî</pre>
            </div>
            <div>
                <h3 style="margin:6px 0">Cookies</h3>
                <pre id="cookies-json">‚Äî</pre>
            </div>
        </div>

        <div class="actions mt12">
            <button class="btn" id="btn-create">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
        </div>

        <div class="statusbar mt10">
            <div class="badge" id="orders-status">status: ‚Äì</div>
            <div class="badge" id="orders-time">time: ‚Äì ms</div>
            <div class="spacer"></div>
        </div>
    </section>
</main>

<div class="loader" id="loader"></div>
<div class="toasts" id="toasts"></div>
<script src="/assets/app.js"></script>
<script>
    bindLogout('#btn-logout');

    const rows   = document.getElementById('rows');
    const filterI = document.getElementById('p-filter');
    const badgeCount = document.getElementById('badge-count');
    const badgeSum   = document.getElementById('badge-sum');
    const cartPre = document.getElementById('cart-json');
    const cookiesPre = document.getElementById('cookies-json');

    let allProducts = [];
    let cart = {}; // { product_id: qty }

    document.getElementById('btn-load').addEventListener('click', loadProducts);
    document.getElementById('btn-clear').addEventListener('click', ()=>{ cart={}; renderCart(); renderProducts(); });
    document.getElementById('btn-create').addEventListener('click', createOrder);
    filterI.addEventListener('input', renderProducts);

    showCookies();
    loadProducts();

    function showCookies(){
      const raw = document.cookie || '';
      const parsed = raw.split(';').reduce((acc,p)=>{
        const i=p.indexOf('='); if(i>0) acc[p.slice(0,i).trim()] = decodeURIComponent(p.slice(i+1)); return acc;
      }, {});
      cookiesPre.textContent = JSON.stringify({ raw, parsed }, null, 2);
    }

    async function loadProducts(){
      const data = await apiRequest('orders','GET','/api/products');
      allProducts = data.products || [];
      renderProducts();
    }

    function renderProducts(){
      const q = (filterI.value||'').trim().toLowerCase();
      const rowsData = q ? allProducts.filter(p =>
        String(p.name||'').toLowerCase().includes(q) ||
        String(p.description||'').toLowerCase().includes(q)
      ) : allProducts;

      rows.innerHTML = rowsData.map(p => {
        const qty = cart[p.id] || 0;
        const img = p.image_url ? `<img src="${esc(p.image_url)}" alt="">` : `<img src="data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2232%22 height=%2232%22><rect width=%2232%22 height=%22332%22 fill=%22%23121826%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%239aa3b2%22 font-size=%2212%22>üì¶</text></svg>')}" alt="">`;
        return `
          <div class="row-item">
            ${img}
            <div class="name" title="${esc(p.name)}">${esc(p.name)}</div>
            <div class="desc" title="${esc(p.description||'')}">${esc(p.description||'')}</div>
            <div class="price">${(Number(p.price_cents)/100).toFixed(2)}</div>
            <div class="qty">
              <button class="btn secondary" data-act="dec" data-id="${p.id}">-</button>
              <input data-id="${p.id}" value="${qty}" inputmode="numeric"/>
              <button class="btn secondary" data-act="inc" data-id="${p.id}">+</button>
            </div>
          </div>
        `;
      }).join('');

      // wire controls
      rows.querySelectorAll('button[data-act="inc"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = Number(btn.dataset.id);
          cart[id] = (cart[id]||0) + 1;
          renderProducts(); renderCart();
        });
      });
      rows.querySelectorAll('button[data-act="dec"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = Number(btn.dataset.id);
          cart[id] = Math.max(0, (cart[id]||0) - 1);
          if(cart[id]===0) delete cart[id];
          renderProducts(); renderCart();
        });
      });
      rows.querySelectorAll('input[data-id]').forEach(inp=>{
        inp.addEventListener('change', ()=>{
          const id = Number(inp.dataset.id);
          let v = Number(inp.value);
          if(!Number.isInteger(v) || v<0) v = 0;
          if(v===0) delete cart[id]; else cart[id]=v;
          renderProducts(); renderCart();
        });
      });
    }

    function renderCart(){
      const items = Object.entries(cart).map(([pid, qty])=>({ product_id: Number(pid), qty: Number(qty) }))
                                    .filter(x=>x.qty>0);
      cartPre.textContent = JSON.stringify({ items }, null, 2);

      // –ª–æ–∫–∞–ª—å–Ω—ã–π total –¥–ª—è UI
      let sum = 0, count = 0;
      for(const {product_id, qty} of items){
        const p = allProducts.find(x=>x.id===product_id);
        if(!p) continue;
        sum += Number(p.price_cents||0) * qty;
        count += qty;
      }
      badgeSum.textContent = 'total: ' + (sum/100).toFixed(2);
      badgeCount.textContent = 'items: ' + count;
    }

    async function createOrder(){
      const items = Object.entries(cart).map(([pid, qty])=>({ product_id: Number(pid), qty: Number(qty) }))
                                    .filter(x=>x.qty>0);
      if(items.length===0) return toast('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞','err');
      try{
        const res = await apiRequest('orders','POST','/api/orders', { items });
        toast('–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω: #'+res.order.id, 'ok');
        cart = {};
        renderProducts(); renderCart();
      }catch(err){
        toast(err.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞','err');
      }
    }
</script>
</body>
</html>
